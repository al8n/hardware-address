# Quick Guide: Publishing to npm

## Prerequisites

1. Install wasm-pack:
```bash
curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
# Or via cargo:
cargo install wasm-pack
```

2. Login to npm:
```bash
npm login
```

## Building for npm

Simply run the build script:

```bash
./build-npm.sh
```

This will:
- Build the WASM package for bundler target (most compatible)
- Generate TypeScript definitions automatically
- Copy the npm-specific README
- Place everything in the `./pkg` directory

## Testing Locally

Before publishing, test the package locally:

```bash
cd pkg
npm link
```

Then in a test project:
```bash
npm link hardware-address
```

Test with a simple script:
```javascript
import { MacAddr } from 'hardware-address';

const addr = MacAddr.parse('00:00:5e:00:53:01');
console.log(addr.toString());
```

## Publishing to npm

Once tested, publish from the `pkg` directory:

```bash
cd pkg
npm publish
```

## Publishing with GitHub Actions (Automated)

The repository includes a GitHub Actions workflow for automated publishing.

### Setup:

1. Get your npm token:
   - Go to https://www.npmjs.com/settings/YOUR_USERNAME/tokens
   - Click "Generate New Token" → "Classic Token"
   - Select "Automation"
   - Copy the token

2. Add to GitHub Secrets:
   - Go to your repository on GitHub
   - Settings → Secrets and variables → Actions
   - Click "New repository secret"
   - Name: `NPM_TOKEN`
   - Paste your token

3. Create a release:
   - Create and push a git tag: `git tag v0.1.3 && git push --tags`
   - Create a GitHub release from that tag
   - The workflow will automatically build and publish to npm

## Files Generated by wasm-pack

After building, the `pkg/` directory contains:

- `hardware_address.js` - JavaScript wrapper
- `hardware_address_bg.wasm` - WebAssembly binary
- `hardware_address_bg.js` - WASM bindings
- `hardware_address.d.ts` - **Auto-generated TypeScript definitions**
- `hardware_address_bg.wasm.d.ts` - WASM types
- `package.json` - Auto-generated from Cargo.toml
- `README.md` - Copied from README.npm.md
- `LICENSE-*` - License files

**Note**: TypeScript definitions are automatically generated by wasm-bindgen based on your Rust code's doc comments and types. No manual .d.ts files needed!

## Updating the Package

1. Update version in `Cargo.toml`
2. Run `./build-npm.sh`
3. Test the package
4. Publish: `cd pkg && npm publish`

## Troubleshooting

### Build fails
- Ensure wasm32 target is installed: `rustup target add wasm32-unknown-unknown`
- Update wasm-pack: `cargo install wasm-pack --force`

### "wasm-opt" errors
The Cargo.toml already has `wasm-opt = false` to avoid optimization issues. If you want to enable it later:
```toml
[package.metadata.wasm-pack.profile.release]
wasm-opt = ["-O2"]  # Use -O2 instead of -O4 for better compatibility
```

### Package already exists
- Increment the version number in Cargo.toml
- Rebuild and publish

## Resources

- [wasm-pack documentation](https://rustwasm.github.io/docs/wasm-pack/)
- [wasm-bindgen guide](https://rustwasm.github.io/docs/wasm-bindgen/)
